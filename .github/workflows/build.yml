name: Build EXE

on:
  # Build when a release is created
  release:
    types: [created]
  # Or manually trigger from Actions tab
  workflow_dispatch:

jobs:
  # Build EXE
  build:
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install sv-ttk
          pip install Pillow
      
      - name: Build EXE
        run: |
          python -c "
          import sv_ttk
          import os
          sv_ttk_path = os.path.dirname(sv_ttk.__file__)
          spec = '''# -*- mode: python ; coding: utf-8 -*-
          import sv_ttk
          import os
          sv_ttk_path = os.path.dirname(sv_ttk.__file__)
          a = Analysis(
              ['whisper_gui.py'],
              pathex=[],
              binaries=[],
              datas=[
                  (r\"''' + sv_ttk_path + '''\", 'sv_ttk'),
                  ('icon.ico', '.'),
                  ('logo.png', '.'),
                  ('version.txt', '.'),
              ],
              hiddenimports=['sv_ttk', 'PIL', 'PIL.Image', 'PIL.ImageTk'],
              excludes=['whisper', 'torch', 'torchaudio', 'torchvision', 'scipy', 'pandas', 'matplotlib', 'tensorflow', 'keras'],
              noarchive=False,
          )
          pyz = PYZ(a.pure)
          exe = EXE(
              pyz, a.scripts, a.binaries, a.datas, [],
              name=\"FinalWhisper\",
              debug=False,
              strip=False,
              upx=True,
              console=False,
              icon=\"icon.ico\",
          )
          '''
          with open('FinalWhisper.spec', 'w') as f:
              f.write(spec)
          "
          pyinstaller FinalWhisper.spec --clean --noconfirm
      
      - name: Upload EXE to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/FinalWhisper.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload EXE as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FinalWhisper-EXE
          path: dist/FinalWhisper.exe
